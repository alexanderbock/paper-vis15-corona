\documentclass[journal]{vgtc}                % final (journal style)
%\documentclass[review,journal]{vgtc}         % review (journal style)
%\documentclass[widereview]{vgtc}             % wide-spaced review
%\documentclass[preprint,journal]{vgtc}       % preprint (journal style)
%\documentclass[electronic,journal]{vgtc}     % electronic version, journal

%% Please use one of the ``review'' options in combination with the
%% assigned online id (see below) ONLY if your paper uses a double blind
%% review process. Some conferences, like IEEE Vis and InfoVis, have NOT
%% in the past.

\usepackage{mathptmx}
\usepackage{graphicx}
\usepackage{times}
\usepackage[usenames,dvipsnames,svgnames]{xcolor}
\usepackage[bookmarks,backref=true,linkcolor=black]{hyperref} 
\usepackage{subfigure}
\usepackage{gensymb}
%\usepackage{flushend}

\hypersetup{
  pdfauthor = {},
  pdftitle = {},
  pdfsubject = {},
  pdfkeywords = {},
  colorlinks=true,
  linkcolor= black,
  citecolor= black,
  pageanchor=true,
  urlcolor = black,
  plainpages = false,
  linktocpage
}

\onlineid{0}
\vgtccategory{Research}
\vgtcinsertpkg
%\preprinttext{To appear in IEEE Transactions on Visualization and Computer Graphics.}

\def\etal{\textit{et al.}}
%\definecolor{MyGreen}{rgb}{0,0.7,0}
%\definecolor{MyWhite}{rgb}{1,1,1}
%\definecolor{MyGray}{rgb}{0.5,0.5,0.5}
%\definecolor{LightGray}{rgb}{0.7,0.7,0.7}
%\definecolor{DarkGray}{rgb}{0.3,0.3,0.3}
%\definecolor{DarkYellow}{rgb}{0.7,0.7,0.0}
%\definecolor{MyNavyBlue}{rgb}{0.2,0.3,0.7}
%\definecolor{darkgreen}{rgb}{0,0.55,0}
%\newcommand{\black}[1]{{\color{Black} #1}}
%\newcommand{\white}[1]{{\color{MyWhite} #1}}
%\newcommand{\gray}[1]{{\color{MyGray} #1}}
%\newcommand{\red}[1]{{\color{red} #1}}
%\newcommand{\green}[1]{{\color{MyGreen} #1}}
%\newcommand{\blue}[1]{{\color{MyNavyBlue} #1}}
%\newcommand{\yellow}[1]{{\color{DarkYellow} #1}}
%\newcommand{\maybe}[1]{\yellow{#1}}
%\newcommand{\rout}[1]{\red{\sout{#1}}}
%\newcommand{\repl}[2]{\rout{#1} \green{#2}}
%\newcommand{\fix}[1]{\red{\emph{(#1)}}}
%\newcommand{\Fix}[1]{\begin{itemize} \renewcommand\labelitemi{\red{--}} \item \red{#1} \end{itemize}}

\hyphenation{analysis}

\newcommand{\todo}[1] {\textbf{[~}\textcolor {red}{#1}\marginpar{\textcolor {red}{\centerline{{\Huge \textbf{!}}}}}\textbf{~]}}
\newcommand{\question}[1] {\textbf{[~}\textcolor {darkgreen}{#1}\marginpar{\textcolor {darkgreen}{\centerline{{\Huge \textbf{!}}}}}\textbf{~]}}
\newcommand{\diff}[1]{[\textcolor{blue}{#1}\marginpar{\textcolor{blue}{\centerline{{\Huge \textbf{!}}}}}]}

\title{Visual Verification of Space Weather Ensemble Simulations}

\author{
%    Alexander~Bock,~\textit{Student Member,~IEEE,}
    Alexander~Bock,
    Asher Pembroke,
    M. Leila Mays,
    Lutz Rastaetter,\\%
%    Anders Ynnerman,~\textit{Member, IEEE,}
    Anders Ynnerman,
%    and Timo Ropinski~\textit{Member, IEEE}%
    and Timo Ropinski%
}

\authorfooter {
  \item A. Bock, A. Ynnerman are with the Scientific Visualization Group, Link\"oping University, Sweden. E-mail: \{alexander.bock\,$\vert$\,anders.ynnerman\}@liu.se.
  \item A. Pembroke, ML Mays, and L. Rastaetter are with NASA Goddard Space Flight Center, Greenbelt, Maryland. E-mail: \{asher.d.pembroke\,$\vert$\, m.leila.mays\,$\vert$\, lutz.rastaetter\}@nasa.gov.
  \item T. Ropinski is with the Visual Computing Group, Ulm University. E-mail: timo.ropinski@uni-ulm.de.
}

\shortauthortitle{Bock \MakeLowercase{\textit{et al.}}: Visual Verification of Space Weather Simulations}

%% Abstract section.
\abstract{%
We propose a system to analyze and contextualize simulations of coronal mass ejections. As current simulation techniques require manual input, uncertainty is introduced into the simulation pipeline leading to inaccurate predictions that can be mitigated through ensemble simulations. We provide the space weather analyst with a multi-view system providing visualizations to: 1. compare ensemble members against ground truth measurements, 2. inspect time-dependent information derived from optical flow analysis of satellite images, and 3. combine satellite images with a volumetric rendering of the simulations. This three-tier workflow provides experts with tools to discover correlations between errors in predictions and simulation parameters, thus increasing knowledge about the evolution and propagation of coronal mass ejections that pose a danger to Earth and interplanetary travel.
}

\keywords{Visual Verification, Space Weather, Coronal Mass Ejections, Ensemble}

%% ACM Computing Classification System (CCS). 
%% See <http://www.acm.org/class/1998/> for details.
%% The ``\CCScat'' command takes four arguments.

\CCScatlist{ % not used in journal version
 \CCScat{K.6.1}{Management of Computing and Information Systems}%
{Project and People Management}{Life Cycle};
 \CCScat{K.7.m}{The Computing Profession}{Miscellaneous}{Ethics}
}

%% Uncomment below to include a teaser figure.
\teaser{
  \newcommand{\abImageHeight}{4.5cm}
  \centering
  
  \subfigure[Ensemble Selection View] {
    \fbox{\includegraphics[height=\abImageHeight]{figures/EnsembleSelectionView.png}}
    \label{fig:selection}
  }
%  \subfigure[Timeline View] {
%    \fbox{\includegraphics[height=\abImageHeight]{figures/TimelineView.png}}
%  }
  \subfigure[Spatial View] {
    \fbox{\includegraphics[height=\abImageHeight, width=10.5cm]{figures/teaser_rendering.png}}
  }
  \caption{Our proposed system helps space weather analysts to gain a better understanding of ensemble simulations of coronal mass ejections. The Ensemble Selection View (a) shows comparisons for all ensemble members with ground-truth, in-situ measurements to provide the user with a global overview. 
%The Timeline View (b) enables the comparison of time-dependent velocity data derived from optical flow analysis of satellite images and extracted velocity fields from the simulation for multiple instruments in the solar system.
The Spatial View (b) allows the inspection of an interactive volume rendering of the simulation data set that is coregistered with satellite images, as well as spacecraft and planetary bodies.}
  \label{fig:teaser}
}

%% Uncomment below to disable the manuscript note
%\renewcommand{\manuscriptnotetxt}{}

%% Copyright space is enabled by default as required by guidelines.
%% It is disabled by the 'review' option or via the following command:
% \nocopyrightspace

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%% START OF THE PAPER %%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand{\kpIndex}{$\textrm{K}_\textrm{P}$}
\setlength\fboxsep{0pt}

\begin{document}
\firstsection{Introduction}
\maketitle
%% \section{Introduction} %for journal use above \firstsection{..} instead
\emph{Space weather} is describing the environmental conditions in our solar system and their effects on planets, spacecraft, and human society. The effects influencing space weather are created by the Sun. \emph{Coronal mass ejections} (CMEs, see Figure~\ref{fig:cme}) occur when the Sun's magnetic field lines reconnect and plasma clouds are accelerated into the solar system. An important part of \emph{Space weather forecasting} is the prediction of the direction and velocity of CMEs to forecast the arrival time and impact when they hit objects in the solar system, such as Earth or spacecraft. When spacecraft are hit by these events, they can cause irreparable damage to electronic systems. In the case of Earth, most of the plasma is deflected by the magnetosphere and funneled towards the poles, creating auroras. However, it also causes geomagnetically induced currents in terrestrial infrastructure, such as power grids. This happened in Quebec in 1989 when a CME struck Earth and induced currents in the power grid causing a blackout nine hours long. The biggest CME on record is the Carrington Event in 1859 that generated auroras as far south as the Sahara and induced currents in telegraph lines that gave electrical shocks to telegraph operators and sparked fires. The Lloyds insurance agency estimated that, in North America alone, a similar event today would cause up to \$2.6 trillion in damages and create blackouts of up to 2 years due to destroyed transformers~\cite{lloyds2013impact}. However, such a situation can be completely mitigated by accurate space weather forecasting.

Current CME predictions created by space weather agencies world-wide are based on magnetohydrodynamic (MHD) simulations whose input parameters are derived from satellite imagery. In the state-of-the-art simulation code, the CME is modeled based on a cone originating from the Sun with a direction (\emph{longitude} and \emph{latitude}), \emph{speed}, and \emph{opening angle} as free parameters. Currently, these cone parameters are manually selected in satellite images, a process which introduces errors into the simulation pipeline and thus requires verification. The main contribution of this paper is providing a system for mitigating this uncertainty for multiple ensemble members, where each member is a simulation run based on different parameters, by comparing the simulation results to ground-truth measurements using visualization.

\begin{figure}[!b]
%\newcommand{\abImageWidth}{\columnwidth}
\centering
%\subfigure[The ENLIL simulation with Cone parameters]{
%  \fbox{\includegraphics[width=\abImageWidth]{figures/Enlil.jpg}}
%    \label{fig:enlil}
%  }
%\hfill{}
%\subfigure[Coronagraph image of a coronal mass ejection with the Earth for scale]{
%\fbox{\includegraphics[width=\columnwidth]{figures/CME.png}}
\fbox{\includegraphics[width=0.5\columnwidth]{figures/CME.jpg}}
%}
\caption{An erupting coronal mass ejection with Earth shown to scale.}
\label{fig:cme}
\end{figure}




\begin{figure*}
\centering
\includegraphics[width=\linewidth]{figures/workflow.pdf}
\caption{The data flow and the proposed visual three-step workflow for the analysis of CME ensemble runs within our system. The available data (top) is preprocessed (middle) before being communicated through visualization (bottom). Using the views, the analyst starts with a global overview of all ensemble members (bottom left) and gains detailed information for specific members through use of the other views (bottom middle and right).}
\label{fig:workflow}
\end{figure*}

\section{Introducing a Visual CME Analysis Workflow}
To alleviate the impact of measurement inaccuracies, simulation ensembles are generated by varying the CME input parameters and performing simulations for each combination. Our visualization system uses a multi-view setup to provide space weather analysts with the tools to verify ensemble runs in two ways:
\begin{itemize}
\item{Ground-truth measurements of the arrival time, speed, and geoeffectivity are measured and compared against predicted values.} 
\item{Renderings of the simulation are compared with satellite images to obtain time-varying information about the simulation's accuracy from multiple locations throughout the solar system.} 
\end{itemize}

The human-in-the-loop paradigm needs to be applied for these verifications as the available data sources are noisy and uncertain. In our integrated system, we combine the available modalities and support the analyst in understanding the simulation results. It is currently not feasible to employ an automatic algorithm to determine whether a simulation accurately represents the measured reality, as the not yet fully understood physical principles might make a change of the simulation necessary. In a participatory design phase together with analysts from one of the world-leading space weather research centers we have developed a novel three step visual workflow (see Figure~\ref{fig:workflow}) that provides the space weather analysts with a greater understanding of the influence of parameter values in the ensemble simulations. The developed system comprises the following visualizations to achieve this goal:

\begin{enumerate}
\item{\emph{Glyph-based visualization} of ensembles providing access to the measured ground-truth values. This allows for a quick reduction of the number of interesting ensemble members the analyst needs to inspect in detail. Furthermore, it allows the analyst to quickly see if any of the simulations match the ground-truth data.}

\item{\emph{Graph plotting} that enables inspection of the time-dependent measurements for each satellite for a specific ensemble member. These measurements are generated by extracting the speed of the CME from simulations, and comparing them with the speed derived by optical flow analysis of satellite images.}

\item{\emph{Volumetric rendering} of the simulation results with integrated positions of different satellites, their instrument field of views, as well as planetary bodies.}
\end{enumerate} 

\begin{figure*}
\newcommand{\abAllCoronagraphImageHeight}{0.45\columnwidth}
\centering
\subfigure[STEREO A Cor2] {
  \fbox{\includegraphics[width=\abAllCoronagraphImageHeight]{figures/20120712_175400_d4c2A.jpg}}
}
\hfill{}
\subfigure[STEREO A HI 1] {
  \fbox{\includegraphics[width=\abAllCoronagraphImageHeight]{figures/20120712_212901_s4h1A.jpg}}
}
\hfill{}
\subfigure[STEREO A HI 2] {
  \fbox{\includegraphics[width=\abAllCoronagraphImageHeight]{figures/20120713_120921_s4h2A.jpg}}
}
\hfill{}
\subfigure[SOHO LASCO C3] {
  \fbox{\includegraphics[width=\abAllCoronagraphImageHeight]{figures/20120713_0806_c3_1024.jpg}}
}
\caption{Images of four of the seven coronagraph imagers we use in our system. The SECCHI suite of instruments (a), (b), and (c) on Stereo A and B gives a continuous view of the space between the Sun and Earth. Soho (d) views the Sun from Earth's perspective.}
\label{fig:coronagraph}
\end{figure*}

Our proposed system is the first to combine volumetric rendering and comparative time-dependent analysis for space weather analysis by fusing multiple streams of data. As these data sources are involving uncertainty, and the processes governing the behavior of CMEs are not yet fully understood, visualization can have a beneficial impact in providing the space weather analysts with information to form and test new hypotheses in order to advance the field of solar physics.  

\section{Space Weather Simulation and Data Acquisition}
This section provides the necessary background information about space weather phenomena (Section~\ref{sec:spaceweather}), the satellites used for image data acquisition, the MHD simulations that are performed to acquire the volumetric data, and the in-situ measurements that are used to verify the simulation runs (Section~\ref{sec:data}). Furthermore, we provide an overview of the currently employed workflow (Section~\ref{sec:currentworkflow}).

\subsection{Coronal Mass Ejections} \label{sec:spaceweather}
Space weather is a collective term that ``describes the conditions in space that affect Earth and its technological systems. Space Weather is a consequence of the behavior of the Sun, the nature of Earth’s magnetic field and atmosphere, and our location in the solar system. The active elements of space weather are particles, electromagnetic energy, and magnetic fields [...]"~\cite{noaaprofile}.

One of the prominent elements of space weather are coronal mass ejections; large plasma clouds that are accelerated to speeds of 500--3000\,km/s. They have been described as the ``most energetic phenomena known to occur in the solar system"~\cite{Kahler:1987jt} and have a major impact on Earth and interplanetary space. Earth and its orbiting satellites are mostly protected by its magnetic field. However, a strong CME compresses Earth's magnetic field, exposing geostationary satellites to high-intensity particles, thus increasing the likelihood of irreversible damage to satellites. Furthermore, the moving magnetic field induces currents on large, conductive structures on Earth, such as power grids, train tracks, or oil pipelines, which damages those infrastructures. Power lines are especially affected as connected transformers are sensitive to fluctuations and can be (and have been) damaged by the effects of a strong CME. An additional effect of a CME hitting Earth is an increase in radiation exposure to airline passengers, further increase the predictability of these events to keep people from harm.

\subsection{Sensors and Simulation Data} \label{sec:data}
In our system, we use three sources of data. First, coronagraph images from three satellites provide information about the structure and time-evolution of CMEs. Second, MHD simulations produce a time-varying, multivariate, volumetric dataset of the CME and are used to predict the arrival time and strength. Third, ground-truth measurements from spacecraft or stations are used to verify and refine the simulations. Figure~\ref{fig:workflow} presents the data flow in our visualization system.

\subsubsection{Coronagraphs} \label{sec:coronagraph}
\begin{figure}[b!]
\newcommand{\abImageWidth}{0.375\columnwidth}
\centering
\subfigure[Orbits of SOHO, STEREO A, and STEREO B in the solar system] {
  \fbox{\includegraphics[height=\abImageWidth]{figures/stereo_location.png}}
  \label{fig:spacecraftlocation}
}
\hfill{}
\subfigure[The Stereo B SECCHI suite of coronagraphs, Cor2, HI 1, and HI 2] {
  \fbox{\includegraphics[height=\abImageWidth]{figures/secchi_labels.png}}
  \label{fig:coronagraphgallery}
}
\caption{(a) The orbits and locations of SOHO, STEREO A and B in July 2012. (b) The three coronagraph imagers of STEREO B with Mercury, Venus, Earth, and the Sun in the same view (not to scale).}
\end{figure}

Coronagraphs are optical telescopes that block out the solar surface with a physical disc in order to capture the much fainter surrounding corona (see Figure~\ref{fig:coronagraph}). In our system, we utilize coronagraph images from three satellites: SOHO and the identical satellites STEREO A and STEREO B. Figure~\ref{fig:spacecraftlocation} shows the orbits of these spacecraft.

\noindent {\bfseries SOHO.} The Solar and Heliospheric Observatory is a satellite orbiting around the L$_1$ Lagrangian point, allowing for uninterrupted observations of the Sun with the Large Angle and Spectrometric Coronagraph (LASCO), containing multiple coronagraphs. We are utilizing the C3 coronagraph that shows the area from 3.7 to 32 solar radii with a field of view of 8 degrees, producing one image every 12 minutes. 

%In preprocessing, the images are aligned to solar north and any additional roll angle is extracted from the meta data and applied to the image~\cite{wells1981fits}.

\noindent {\bfseries STEREO.} The Solar Terrestrial Relations Observatory is a set of two identical satellites, A and B, with slightly lower and higher orbits respectively. Thus, from Earth's point of view, A is moving ahead of Earth while B is falling behind. We make use of three coronagraphs: COR\,2 observes the Sun from 2.5--15 solar radii with a field of view of 8\degree\ and provides an image every 15 minutes. The HI\,1 and HI\,2 imagers observe the space between the Sun and Earth from 15--90 solar radii (20\degree\ field of view) and 70--330 solar radii (70\degree\ field of view) with cadences of 40 minutes and 2 hours respectively. Figure~\ref{fig:coronagraphgallery} shows the fields of view of the three instruments.

\subsubsection{Magnetohydrodynamics Simulation} \label{sec:mhd}
We use the state-of-the-art MHD simulation code ENLIL for simulating the CME~\cite{odstrcil2002merging}. Figure~\ref{fig:teaser} (right) shows the results of the rendering of one time step. The CME simulations assume that the CME input parameters are approximated by a cone~\cite{Arge:2000jz}, described by four parameters: location in longitude and latitude, speed, and the opening angle. These are manually determined using a tool called Stereo CAT, that uses triangulation on STEREO A and STEREO B observations.

\subsubsection{Ground-Truth Measurements} \label{sec:insitu}
Two direct observables are the CME's arrival time and speed at Earth. These ground-truth measurements are the main focus of space weather forecasting. Another measurement is the geoeffectivity index \kpIndex. It is a measure of the strength of the CME's effect on Earth that uses a quasi-logarithmic scale from 0 to 9. However, ENLIL does not model the direction of the CME's internal magnetic field that influences the \kpIndex , but models three angle scenarios of 90\degree , 135\degree , and 180\degree\ for the interplanetary magnetic field. The comparison must be made between the measured and all three simulated geoeffectivities.

\subsection{Current Tools} \label{sec:currentworkflow}
The tools currently available to the space weather analysts are fairly limited. Figure~\ref{fig:currentworkflow:single} shows the current analysis tool used for a single CME simulation. The available plots do not provide any information about the CME's 3 dimensional structure and show the comparison of the radial velocity only at predetermined locations. A major requirement from the analysts was to be able to see the CME's internal structures.

Furthermore, the current tools do not translate well when dealing with simulation ensembles as they only represent each ensemble run in plots without linked views or mental registration. This limitation is the reason that, currently, only a statistical analysis is performed~\cite{mays2015ensemble}. While this analysis produces information about the quality of the ensemble, it does not allow for detailed inspection of individual ensemble members to help understand why they are incorrect.

\begin{figure}
\newcommand{\abImageWidth}{0.9\columnwidth}
\centering
\includegraphics[width=\abImageWidth]{figures/current_workflow.png}
\caption{The currently employed workflow when analyzing single simulations of coronal mass ejections. The plot does not convey the 3 dimensional structure of the CME.}
\label{fig:currentworkflow:single}
\end{figure}

\section{Related Work}
\noindent {\bfseries Ensemble visualization.} Notable work dealing with the visualization of ensembles was done by Bruckner and M\"oller, who developed a system to allow users to explore a simulation parameter space in order to incrementally reach a desired result~\cite{bruckner2010result}. One of the differences to our framework is the a priori unknown desired result. Naturally, many similarities exist with the field of weather forecasting on Earth, which has greatly matured over the years. Sanyal~\etal\ developed a system to explore ensemble simulations for weather forecasting that is most similar to ours~\cite{sanyal2010noodles}. However, the inherent differences in weather forecasting compared to space weather forecasting (2.5D structures vs. full 3D structures, the limited amount of measurement points, and missing theoretical frameworks) limit the applicability of their approach to space weather. Potter~\etal\ presented a system that uses a multi-view setup for ensemble visualization of statistics in climate modeling~\cite{potter2009ensemble}. Their approach informed our choice for a system based on a multi-view setup. There exist a plethora of ensemble visualization techniques that work well on 2 dimensional data, but unfortunately fail to do so in our case. Alabi~\etal\ used a surface slicing approach to show ensemble geometries at once and provided insight into multiple ensemble runs at once~\cite{alabi2012comparative}. This technique is not applicable in our case as we deal with volumetric renderings without a clear geometry. Whitaker~\etal\ generalized contour boxplots to handle ensemble data and aggregate their representations~\cite{whitaker2013contour}, while Kopp~\etal\ are using heatmaps to show ensemble members  distribution~\cite{kopp2014decision}. In both cases, however, the technique is difficult to generalize to three dimensions.

\noindent {\bfseries Space weather.} One of the first attempts of rendering CME simulations was performed by Wang~\etal\ on specialized hardware, allowing for interactive frame rates~\cite{wang2004visualization}. The validity of time-dependent comparisons of CME simulations with satellite imagery was shown in related work by Manchester~\etal ~\cite{manchester2008three} and Rusin~\etal ~\cite{rusin2010comparing}, while Lugaz analyzed the expected accuracy and possible sources of error in this method~\cite{lugaz2010accuracy}. Many visualization techniques have been applied to coronagraph images and coronal mass ejections. Jackson~\etal\ reconstructed a 3 dimensional volume from SMEI's white-light observations and compared these to coronagraph images. Colaninno and Vourlidas proved that the application of optical flow analysis to coronagraph images of CMEs is feasible. They found that ``optical flow maps can [...] provide quantitative measurements''~\cite{Colaninno:2006ef}. Millward~\etal\ designed the software that allows the space weather analysts to manually segment the CME in multiple time steps from multiple view points in order to derive the necessary simulation boundary conditions~\cite{Millward:2013cm}. They also performed an evaluation, achieving a mean CME arrival time forecast accuracy of 7.5h. A variation of this method is currently applied to generate the parameters for ensemble simulations.



%\subsubsection{STEREO}
%Cor2: white light Lyot coronagraph (2.5 - 15 solar radii); orientation: top $\rightarrow$ Solar North; 8 degrees opening angle; isoscele triangle: $a = \frac{2h}{\tan \theta}$
%HI1: 20 degrees FoV; 14.0 degrees off-point; (15-90 solar radii); cadence: 40 minutes; orientation: top $\rightarrow$ equatorial North
%HI2: 70 degrees FoV; 53.7 degrees off-point (70-330 solar radii); cadence: 2 hr; mean square error in positioning (HI2-A: 0.78 pixel, HI2-B: 1.48 pixel; firstHI\_Instrument\_Paper\_Revised  ; self-calibrating since images are used as star trackers; orientation: top $\rightarrow$ equatorial North; not properly usable due to Thomson effect \cite{howard2012thomson, deforest2013thomson, howard2013thomson, vourlidas2006proper, minnaert1930continuous, lugaz2008brightness}; experts want to see it included nevertheless. A CME itself is an optially thin medium which interacts with the Sun's visible light through Thomson scattering~\cite{}. More research has to be done on this end. This is the reason we don't do image comparisons.
%Overlap between HI1 and HI2 of about 5 degrees

%\subsection{MHD Simulations}
%\begin{itemize}
%\item What is ENLIL \cite{odstrcil2002merging}
%\item HEEQ coordinate system; cf. orbit of planets (prograde vs retrograde)
%\item Explain SOTA (cone-model) of boundary conditions
%\item Cone model is a very broad approximation of actual shape of the CME (Example: big flare that missed Earth $\rightarrow$ assumptions wrong)
%\item Sun's rotation causes CME to spiral
%\end{itemize}

\section{System}
Together with the space weather analysts, we developed a system based on a three-tier workflow (see Figure~\ref{fig:workflow}) providing a greater understanding of the influence of parameter values in ensemble simulations and supporting the discoveries bringing ensemble simulations into operational forecasting, thus improving the forecasting.

For each ensemble, a glyph-based comparison with in-situ measurements is presented in the \emph{Ensemble Selection View} (Section~\ref{sec:selection}, Figure~\ref{fig:selection}). In this view the comparisons to the ground-truth data for all ensemble runs are available at one glance. This allows the analyst to quickly gain an overview of the ensemble and make visual correlations between the input parameters and the accuracy of the prediction. The time-varying information of image-based comparisons between simulation and satellite imagery is shown in the \emph{Timeline View} (Section~\ref{sec:timeline}, Figure~\ref{fig:timeline}). This view shows, for a selected ensemble member, the speeds derived from an optical flow analysis and the simulated speed, thus providing access to time-of-flight comparisons. This enables the analyst to quickly assess at which time a simulation error manifests. Each time step in the Timeline View can be selected and inspected in the \emph{Spatial View} (Section~\ref{sec:rendering}, Figure~\ref{fig:rendering}). This view shows the volume rendering of the CME simulation coregistered with the satellite images, spacecraft, and planets. This view allows the analyst to inspect the CME and gain insight about its 3 dimensional structure. This requested feature was not available in the analysts' previous workflow.

\subsection{Ensemble Selection View} \label{sec:selection}
\begin{figure}[t!]
\newcommand{\abImageWidth}{0.7\columnwidth}
\centering
\fbox{\includegraphics[width=\abImageWidth]{figures/ensemble_kp.png}}
\caption{The Ensemble Selection View showing the indices for geoeffectivity for all ensemble runs. The transparent lines are orientated along the magnetic clock angle of 90\degree\ (=horizontal), 135\degree\ (=angled), and 180\degree\ (=vertical) for all ensemble members.}
\label{fig:selectionkp}
\end{figure}

\begin{figure*}
\newcommand{\abImageHeight}{5.25cm}
\centering
\subfigure {
  \includegraphics[height=\abImageHeight]{figures/timeline.pdf}
}
\subfigure {
  \includegraphics[height=\abImageHeight]{figures/timelineview_combined.png}
}
\caption{The Timeline view provides insight into the time-dependent comparison of measured velocities. For each instrument and satellite, the velocity of a passing CME is determined using optical flow analysis and compared against the extracted velocity from the simulation run. Here, the average speeds for each instrument (colored lines) is shown together with the measurements from the simulation (black lines). The numerical values are shown as an overlay. It is possible for the analyst to restrict the Timeline View to individual instruments (bottom right) and display the minimum and maximum velocities as line thickness (top right). The insets (a-d) show closeups of regions in which the measurements of multiple satellites and the simulation correlate.}
\label{fig:timeline}
\end{figure*}

%\begin{figure*}
%\newcommand{\abImageWidth}{1.25\columnwidth}
%\newcommand{\abSmallImageWidth}{0.2\columnwidth}
%\centering
%\subfigure {
%  \includegraphics[width=\abImageWidth]{figures/timelineview_wide.png}
%}
%\begin{minipage}{0.3\columnwidth}
%  \subfigure {
%    \includegraphics[width=\columnwidth]{figures/timelineview_hi1.png}
%  }
%
%  \subfigure {
%    \includegraphics[width=\columnwidth]{figures/timelineview_soho_cor2.png}  
%  }
%\end{minipage}
%\caption{The Timeline view provides insight into the time-dependent comparison of measured velocities. For each instrument and satellite, the velocity of a passing CME is determined using optical flow analysis and compared against the extracted velocity from the simulation run. Here, the average speeds for each instrument (colored lines) is shown together with the measurements from the simulation (black lines).}
%\label{fig:timeline}
%\end{figure*}

The \emph{Ensemble Selection View} (see Figure~\ref{fig:selection}) provides an overview of all ensemble members as a glyph-based visualization. Each ensemble member is characterized by the 4 parameters: \emph{direction} (longitude and latitude), \emph{initial speed}, and the \emph{opening angle}. This view is separated into subviews to provide three cuts of this parameter space and designed to reflect the two dimensional projection of the cones onto the Sun's surface. To this end, the opening angle is mapped to the size of the glyph in all subviews. The main view shows the longitude and latitude on the horizontal and vertical axes, providing the direction of the cone when looking at the Sun. The view is focussed such that it is filled by the available ensemble members. The side views show longitude and speed (bottom left) and speed and latitude (top right) respectively. This setup was chosen to provide a magic mirror-like effect~\cite{konig1999multiple}. We investigated different setups, such as rendering cones using different kinds of glyphs, but we chose this representation as it provided the most intuitive feedback to our experts.

The ground-truth measurements are compared against the predicted values to retrieve a fitness value for each ensemble member. We chose the familiar red-green color scheme to reflect how accurate the chosen prediction matches the measured data. There are three different variants for this view for the three in-situ measurements that we utilize; 1. the arrival time, 2. the speed at which it arrives, and 3. the three \kpIndex\ indices that are calculated. We chose not to show all variants at the same time as the glyph would be otherwise cluttered with uncorrelated information. Instead, we provide the analyst with the ability to switch between the variants without shifting focus away from the view. The combination of an intuitive color scheme and location for each glyph enables the analyst to detect patterns and trends in the fitness of the ensembles; a possibility that is not available in the current workflow. The patterns can be used to start simulation runs using new parameters for which the analyst expects better results, thus checking his hypotheses.

For the arrival time and the arrival speed parameters, the entire glyph is shown in the same color. For the \kpIndex , we decided to divide the glyph into segments, one for each angle prediction with the segments' locations reflecting the orientation of the predicted \kpIndex\ index. Furthermore, we add an overlay to each segment that is oriented to reflect the angle of the \kpIndex ~(see Figure~\ref{fig:selectionkp}). Overlapping glyphs were not found to be a problem in the case of uniformly colored glyphs. This is different for the \kpIndex\ indices due to an increased visual complexity and reduced contrast between different glyphs. In order to visually separate overlapping glyphs, we add a thin black border that delineates each glyph in the view. The median of the simulation is marked with a cross to guide the analyst to the center of the view to start the analysis. Ensemble members can be selected, highlighting the glyph and providing numerical values about the member in the lower right view.

\subsection{Timeline View} \label{sec:timeline}
When an ensemble member is selected in the Ensemble Selection View, its timeline is presented in the \emph{Timeline View}~(see Figure~\ref{fig:timeline}). This view shows the CME's speed for all time steps for coronagraph images as well as simulation data. Displaying the speed was chosen, as the accuracy of the speed directly impacts the CME's arrival time. At the same time, the speed at each time step is an important measurement as unexpected changes often result in prediction errors and, thus, have to be investigated.

\subsubsection{Optical Flow Analysis} \label{sec:opticalflow}
The calibrated and preprocessed satellite images are publicly available on the Internet at the respective science teams' webpages. In order to extract the CME's velocity from the satellite images, we use optical flow analysis on image pairs. Optical flow methods compute a vector field that describes the movement of features from one image to the next (see Figure~\ref{fig:opticalflow}). We use the optical flow method presented by Sun~\etal\ that is one of the state-of-the-art implementations~\cite{sun2010secrets}. However, our system does not depend on the specific algorithm that is used to extract the optical flow. We found that smoothing the images is a good compromise between the amount of detail and the signal-to-noise ratio result. It enhances the results as the satellite images are often the target of cosmic rays that have an effect on single pixels in the instruments. Thus, smoothing the image reduces the noise in the reconstructed velocity field. Using the optical flow analysis on the satellite images, we obtain the speed for each pixel projected onto the image plane. By taking the time between acquisition of images into account, we can compute the projected speed of the CME in each pixel for each image. Due to the location and geometric setup of the HI 1 and HI 2 coronagraphs (see Figure~\ref{fig:coronagraphgallery}), a passing CME must move to the left (STEREO A) or to the right (STEREO B) and we can discard velocity vectors that move in the opposite directions.

One source of inaccuracy in this technique that requires further study is the effect of Thomson scattering in the image. As we are dealing with a coronagraph in the visible spectrum of an optically thin plasma, the perceived brightness of the CME is dependent on the angle between the viewer and the Sun. This effect makes it difficult to measure densities based on image intensity and it is also known to distort the apparent location of the CME. However, Colaninno~\etal\ found that using optical flow analysis for detecting velocities can "provide quantitative measurements of the wave propagation speeds"~\cite{Colaninno:2006ef}.

\subsubsection{Simulation Speed} \label{sec:simulationvelocity}
3 dimensional velocity is one of the simulated parameters in the ENLIL MHD model and can, thus, be extracted from the data. However, multiple aspects come into play in this approach. First, in order for a correct comparison, the scene camera has to be positioned at the correct location with the correct view direction and field-of-view settings. We retrieve those attributes from a library provided called SPICE. This allows for querying of satellite positions as well as the necessary instrument attributes. The second aspect becomes visible in Figure~\ref{fig:simulationvelocitygathering}; for each pixel in the image, there are many valid velocities in the dataset. To generate the resulting velocity vector for each pixel, we average the velocities for all samples along each view ray. As no further information about the CME is available, this approach provides the best approximation for the CME's velocity for each point.

In the ENLIL simulation the velocities are provided in spherical coordinates, as radial velocity and two angular velocities. We convert those velocities to Cartesian coordinates in order to project the simulation velocity vector into the image plane. This projection is necessary to be able to compare the simulation speed, given in world space coordinates, to the optical flow-based speed, given in screen-space coordinates. Given the image plane normal $n$ (which, in the case of a symmetric view frustum equals the view direction) and a velocity vector $v$, we can retrieve the projected velocity vector $v_p = v\,-\,\left(\left(v \cdot n \right) * n \right))$. In a second step, we project $v_p$ into screen-space coordinates using the image size $s$, the field of view $f$ and the distance $d$ from the camera to the velocity: $ c = \left(s / f \right) \times \tan^{-1}\left( ||v_p|| / d \right)$. $c$ is the number of pixels that the projected velocity vector covers on the screen, thus being the same unit as returned by the optical flow method. For the distance $d$ we use the averaged world space position for each view ray for the distance calculation, analogous to the velocity. Figure~\ref{fig:timeline} shows the computation of the simulation speed on a dataset consisting of 360 timesteps with a resolution of 832x30x90.
\begin{figure}
\newcommand{\abSimulationImageWidth}{0.47\columnwidth}
\centering
\subfigure[Optical Flow Speed] {
  \fbox{\includegraphics[width=\abSimulationImageWidth, height=\abSimulationImageWidth]{figures/20120713T094800.png}}
  \label{fig:opticalflow}
}
\hfill{}
\subfigure[Velocity gathering]{
  \fbox{\includegraphics[width=\abSimulationImageWidth, height=\abSimulationImageWidth]{figures/cme_velocity.png}}
  \label{fig:simulationvelocitygathering}
}
\caption{(a) The magnitude of the screen-space speeds extracted using optical flow methods from the SOHO satellite at July 13 2012. (b) A schematic overview of the velocity distribution in a CME. By averaging all velocities along the view ray, non-principal velocities are cancelled by the opposite side and only the principle velocity remains.}
\end{figure}



\subsubsection{Representation} \label{sec:representation}
We present both speeds to the user in a single graph view (see Figure~\ref{fig:timeline}). This allows the analyst to directly compare the two measured speeds for all instruments. Each instrument for each available satellite is represented by a colored line showing the speeds for all time steps. In addition, the ENLIL simulation results for all instruments are shown as separate lines. In order to filter out any background velocities, we only consider values that lie above the 75\textsuperscript{th} percentile for each image. This approach was necessary as large parts of the image are filled with the background solar wind. Limiting the values to the 75\textsuperscript{th} percentile provided a useful value to filter the CME from the background, as the speed of the CME is orders of magnitude higher than the background solar wind. In order to suppress noise in the data, we apply a second filter to the data: as the initial speed is, with a level of uncertainty, known for each ensemble member, we have a limit to filter out values that can be attributed to errors in the optical flow algorithm. The value used for the centerline is the average of all velocities in an image after applying the filters. The analyst can change the view to also display the minimum and maximum values. The minimum and maximum values determine the thickness of the line at each time step and can be used by the analyst to judge the spread of velocities for each instrument (see Figure~\ref{fig:timeline} top right). In general, the analyst only needs the average speed, so the minimum and maximum values are not displayed constantly. By default, the system shows all instruments at the same time, however we provide the possibility to hide instruments or satellites to allow for detailed inspection of individual measurements.

The user can interact with the Timeline View using the mouse and inspect each individual time step. For each time, the values of the measured velocities are presented in an on-screen window. Furthermore, by selecting a specific time the analyst can load the related datasets in the third step of the workflow, the Spatial View, for detailed inspection.


\subsection{Spatial View} \label{sec:rendering}
\begin{figure}
\newcommand{\abRenderingImageWidth}{0.9\columnwidth}
\centering
\fbox{\includegraphics[width=\abRenderingImageWidth]{figures/renderingview.png}}
\caption{The Spatial View provides the analyst with access to all datasets we make use of in the system. It shows a volumetric rendering of the selected ensemble member at the given time. In the same scene, the images from the different satellites are integrated at their correct positions, giving the user the possibility to inspect the data.}
\label{fig:rendering}
\end{figure}

Selecting a time step in the Timeline View will set up the \emph{Spatial View} (see Figure~\ref{fig:rendering}) that consists of the ENLIL simulation volume data, spacecraft and planets, as well as the satellite images for the selected time step in their registered locations. As the space weather research center was not utilizing volume rendering to analyze simulations before, there was a special interest to include these to inspect the 3 dimensional structure of the CMEs. In the following steps, we will describe each individual component of the scene in detail.

\subsubsection{Satellite Images} \label{sec:satelltes}
Providing the expert with the ability to inspect the satellite data together with the other modalities is crucial to be able to compare the satellite images with the simulation data and thus gain additional insight about correlation between simulation and satellite images. In order to ease these comparisons, we provide an interface to the user to move the camera into the location of a satellite with the correct orientation and field of view, as well as interactively modify the transparency of all image projections (see Figure~\ref{fig:satellitecomparison}). For each satellite and each instrument the image closest to the requested time is projected onto a plane in the scene using perspective texturing as described by Everitt~\etal~\cite{Everitt:2001tg}. The distance of the image plane can be modified by the user. The image and metadata is retrieved from the FITS files that are published by the respective science teams and contain exposure, acquisition time, internal roll angle of the spacecraft and more.

\subsubsection{Volume Rendering} \label{sec:volumerendering}
The ENLIL MHD simulation code in our system is natively computed on a spherical grid with the Sun at the origin. This means that the data is available as a rectangular volume where the principal axes are the radius $r$, longitude $\phi$, and latitude $\theta$. Instead of resampling the volume onto a regular grid, which would drastically increase the memory requirements, we perform the raymarching in Cartesian world space, but transform each sample point into the spherical volume space. This method was inspired by the work of Balabanian~\etal ~\cite{balabanian-2007-ant}. We utilize a tessellated sphere as the entry-exit points, as this provides effective and inexpensive empty space skipping since about 50\% of the otherwise empty volume is removed. During the raymarching, each Cartesian prospective sampling point $(x,y,z)$ on the view ray is transformed into the spherical coordinate system and the resulting tuple $(r, \phi, \theta)$ is used to look up the value in the spherical volume.

Currently, the volume rendering technique is the limiting factor on data sizes as the straight-forward implementation requires the volume to be resident in graphics memory. However, this restriction can be lifted by implementing an out-of-core rendering technique.

\noindent {\bfseries Interpolation.} For each sample point along the ray, trilinear interpolation is performed in spherical volume space. Using this scheme, the interpolation is effectively performed along great circles and thus performs analogous to Spherical Linear Interpolation (SLERP). We investigated the difference between positional interpolation that is based on the Cartesian position, and the above interpolation scheme and found a slightly improved result through the value interpolation at negligible performance cost.

\noindent {\bfseries Adaptive sampling.} An additional benefit of the spherical volume is the distribution of sample points. While it is a regular distribution in spherical volume space, when converting samples into Cartesian world space, it becomes non-uniform with a density fall-off of $1/r^3$. It is possible to exploit the $1/r^3$ dependency in data density in the rendering step to perform data-aware importance sampling along the view ray by changing the step size of the ray based on the distance of the sample to the center of the sphere. Using this technique, we achieved improved visual quality while doubling the rendering performance.

\noindent {\bfseries Variables.} The ENLIL simulation produces multi-variate datasets for each ensemble member. We utilize 3 variables in this part of our system: 1. the $N$ variable denotes the number of simulated particles per cubic centimeter multiplied by $r^2$ to negate the radial density falloff. 2. the $\rho$ parameter is the atomic mass density which is derived by multiplying $N$ with a particle mass. We perform multi-volume rendering using both parameters for our final results in order to visually separate the background solar wind and the different structures within the CME. Together with the analysts, we improved the simulation's use for volume rendering. Instead of running the simulation once, ENLIL produces the CME-infused variables as before, but also computes a second set of variables only containing the background solar wind. We display the difference between the two simulation runs, resulting in a more accurate rendering of the CME structure alone. We do not perform the same operation for the velocity field as computed in Section~\ref{sec:simulationvelocity} as the effect of this subtraction would be minimal since the speed of the background solar wind is orders of magnitude lower than the speed of the CME. 3. The $dp$ parameter is a set of tracer particles that are spawned in outline of the original CME. By advecting and tracing these particles between time steps, it is possible to use this parameter as a segmentation mask.

\subsubsection{Integrated Rendering} \label{sec:integration}
\begin{figure}
\newcommand{\abSatelliteComparisonImageWidth}{0.4\columnwidth}
\centering
\subfigure {
  \fbox{\includegraphics[width=\abSatelliteComparisonImageWidth]{figures/coronagraph.jpg}}
}
\subfigure {
  \fbox{\includegraphics[width=\abSatelliteComparisonImageWidth]{figures/coronagraph_simulation.jpg}}
}
  \caption{Adding transparency allows the user to quickly compare the results of the simulation's volume rendering with the available images.}
\label{fig:satellitecomparison}
\end{figure}


In order to display the volume rendering coregistered with multiple transparent geometries, we make use of an order-independent transparency method. Our system uses a per-fragment sorting technique that is based on an A-Buffer technique as presented by Lindholm~\etal~\cite{Lindholm:2014fm}. The technique operates by gathering fragments in a per-pixel linked list that is depth sorted in a second pass, thus allowing for high-performant support of a sufficient level of depth complexity and the possibility of transparent objects integrated in the volume rendering. 

\section{Application Case} \label{sec:applicationcase}
We applied our system to multiple application cases, such as the Carrington-level CME of July 2012 and a simulation run of a CME from May 2011. However, the main application case for this paper is the real-time ensemble modeling of an Earth-directed CME that was observed on April 18th, 2014. For detailed information about the CME and description of the manual ensemble generation process, we refer the reader to~\cite{mays2015ensemble}. The application case consists of 37 ensemble members with the CME propagation directions clustered between -30\degree\ to -40\degree\ latitude, and around 10\degree\ west of the Sun-Earth line in longitude, while speeds range from $\approx$1300 to 1600 km/s. The prediction error for the mean predicted CME arrival time was -5.2 hours and the observed arrival time was just within the ensemble predicted spread. The ensemble members with arrival times closest to the observed time had CME input speeds in the range of 1200-1400 km/s, latitudes near -40\degree\ and half widths around 35\degree -40\degree . The NOAA real-time observed \kpIndex\ index reached 5 on 20 April with the CME arrival. The standard deviation of the overall \kpIndex\ forecast probability distribution is 1.1, with 84\% of the forecasts falling between \kpIndex\ 5 to 7.

Figure~\ref{fig:selection} shows the Ensemble Selection view for this event. In the main view, it shows that ensembles with lower latitudes and lower speeds were more accurate in predicting the arrival time. Retrieving this information from the ensemble member was not possible in the previous systems, as the correlation between accuracy and direction was not presented. This information can now be used to query new simulations with low latitude and low speed to find the best agreement with the ground-truth data. Figure~\ref{fig:selectionkp} shows the comparisons of geoeffectivities for the same event. It shows that the 90\degree\ is the most accurate prediction, followed by the 135\degree . % Leila+Lutz' findings

Using the volumetric rendering, our experts have gained new insight about the CME's structure. They found holes in the shock front of the CME, which were previously unknown and will result in a solar physics publication (see Figure~\ref{fig:cmestructure}). Furthermore, the rendering was used for ruling out unphysical simulation results, such as plasma being ejected against the solar wind flow.

\begin{figure}
\newcommand{\abImageWidth}{0.45\columnwidth}
\centering
\subfigure {
  \fbox{\includegraphics[width=\abImageWidth]{figures/cme_structure.png}}
}
\subfigure {
  \fbox{\includegraphics[width=\abImageWidth]{figures/space.png}}
}
\caption{Two CME structures contained in the simulation datasets that were discovered using our system and were previously unknown.}
\label{fig:cmestructure}
\end{figure}


\section{Conclusions \& Future Work} \label{sec:futurework}
In this paper, we proposed a system that enables space weather analysts to explore the parameter space of ensemble simulations of coronal mass ejections. The system was developed in close collaboration with leading expert analysts from one of the few space weather research centers in the world in a participatory design approach. This approach proved to be successful due to the rapid iterations in the development process and has been beneficial for both the visualization aspects as well as the space weather research aspects of the project.

We presented a visualization system using a three-tier workflow that allows the analyst to compare ensemble simulations with measured ground-truth data, to correlate the time-dependent evolution of interplanetary coronal mass ejections with optical flow analysis from satellite images, and to inspect a volumetric rendering of the simulation dataset with integrated satellite images and spacecraft positions. Using our system, the analyst can gain a deeper understanding of the parameter sensitivity of ensemble simulations and, at the same time, inspect the CME's 3 dimensional structure for each ensemble member.

For future work, we would like to further improve the usability of the system based on the inspiration of the domain experts. Instead of relying on averaging for retrieving the velocity field from the simulation data, we want to investigate reconstruction approaches that are based on the density distribution in the CME. In order to achieve this and, in the process, make the output of the volume rendering more comparable to the coronagraph images, we will implement scattering methods in order to accurately simulate Thomson scattering~\cite{howard2012thomson} and create synthetic coronagraph images. As a measure to improve the quality of the optical flow algorithm, we want to design an optical flow algorithm that takes the unique, radial-dominant aspects of the coronagraph images into account. Lastly, we will investigate the use of interplanetary scintillation as another, real time, measurement with which to compare the simulated coronal mass ejection.


%% if specified like this the section will be committed in review mode
\section*{Acknowledgments}
The authors would like to thank the reviewers for their helpful comments that helped to improve this work. Simulation results have been provided by the Community Coordinated Modeling Center at Goddard Space Flight Center through their public Runs on Request system. The CCMC is a multi-agency partnership between NASA, AFMC, AFOSR, AFRL, AFWA, NOAA, NSF and ONR. The presented visualization concepts have been realized using the Voreen framework (www.voreen.org).
%\nocite{*}
%\newpage

\bibliographystyle{abbrv}
%%use following if all content of bibtex file should be shown
%\nocite{*}
\bibliography{bibliography}
\end{document}

